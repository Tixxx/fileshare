import time
import tensorflow as tf
from petastorm import make_batch_reader
from petastorm.tf_utils import make_petastorm_dataset


schema_fields = ["indexed_derived_is_polymorphed", "indexed_derived_product_type_name", "indexed_derived_is_airport_trip", "auto_transformed_derived_lifetime_completed_trip_count", "auto_transformed_derived_fare_split_surge_multiplier_sum_1day", "auto_transformed_derived_minutes_worked_sum_2day", "auto_transformed_derived_driver_latenight_trip_count_total", "auto_transformed_derived_driver_1star_count_1week", "auto_transformed_derived_minutes_active_sum_3day", "auto_transformed_derived_completed_surge_multiplier_count_1week", "auto_transformed_derived_minutes_active_sum_1week", "auto_transformed_derived_minutes_active_sum_7week", "auto_transformed_derived_total_fare_sum_1week", "auto_transformed_derived_distance_btw_driver_stop_near_request_and_request", "auto_transformed_derived_completed_duration_sum_1day", "auto_transformed_derived_minutes_worked_sum_4day", "auto_transformed_derived_minutes_worked_sum_6week", "auto_transformed_derived_duration_sum_1day", "auto_transformed_derived_inappropriate_driver_feedback_count_total", "auto_transformed_derived_trip_count_1week", "auto_transformed_derived_fare_split_distance_sum_1week", "auto_transformed_derived_driver_night_request_count_total", "auto_transformed_derived_driver_canceled_trip_count_1day", "auto_transformed_derived_fare_split_surge_count_1day", "auto_transformed_derived_driver_lifetime_trip_count", "auto_transformed_derived_completed_trip_count_1day", "auto_transformed_derived_total_fare_sum_1day", "auto_transformed_derived_minutes_worked_sum_7week", "auto_transformed_derived_completed_eta_diff_sum_1week", "auto_transformed_derived_request_timestamp_utc", "auto_transformed_derived_flirt_driver_feedback_count_total", "auto_transformed_derived_eta_diff_sum_1day", "auto_transformed_derived_surge_multiplier_sum_1week", "auto_transformed_derived_minutes_worked_sum_4week", "auto_transformed_derived_distance_btw_last_rider_before_trip_begin_and_request", "auto_transformed_derived_duration_last_rider_location_to_trip_begin", "auto_transformed_derived_driver_night_trip_count_total", "auto_transformed_derived_eta_diff_sum_1week", "auto_transformed_derived_completed_total_fare_sum_1week", "auto_transformed_derived_duration_sum_1week", "auto_transformed_derived_max_rider_speed", "auto_transformed_derived_canceled_trip_count_1week", "auto_transformed_derived_avg_trip_speed_mph", "auto_transformed_derived_driver_num_ratings_12week", "auto_transformed_derived_completed_surge_multiplier_sum_1week", "auto_transformed_derived_minutes_active_sum_1day", "auto_transformed_derived_kiss_driver_feedback_count_total", "auto_transformed_derived_completed_total_fare_sum_1day", "auto_transformed_derived_minutes_active_sum_2week", "auto_transformed_derived_completed_trip_count_1week", "auto_transformed_derived_completed_surge_count_1week", "auto_transformed_derived_surge_multiplier_count_1week", "auto_transformed_derived_avg_request_to_begin_speed_mph", "auto_transformed_derived_distance_btw_driver_stop_near_request_and_last_rider_before_trip_begin", "auto_transformed_derived_minutes_active_sum_5day", "auto_transformed_derived_completed_surge_multiplier_count_1day", "auto_transformed_derived_minutes_worked_sum_3day", "auto_transformed_derived_distance_sum_1week", "auto_transformed_derived_fare_split_surge_multiplier_count_1day", "auto_transformed_derived_fare_split_trip_count_1day", "auto_transformed_derived_fare_split_total_fare_sum_1day", "auto_transformed_derived_driver_suv_count_total", "auto_transformed_derived_driver_latenight_request_count_total", "auto_transformed_derived_distance_btw_last_rider_before_trip_begin_and_trip_begin", "auto_transformed_derived_driver_cancellation_count_total", "auto_transformed_derived_completed_duration_sum_1week", "auto_transformed_derived_duration_from_request_to_trip_begin", "auto_transformed_derived_minutes_active_sum_6day", "auto_transformed_derived_minutes_active_sum_5week", "auto_transformed_derived_driver_trip_count_total", "auto_transformed_derived_rider_min_dist_to_pickup", "auto_transformed_derived_canceled_trip_count_1day", "auto_transformed_derived_minutes_active_sum_3week", "auto_transformed_derived_min_rider_speed", "auto_transformed_derived_surge_multiplier_sum_1day", "auto_transformed_derived_distance_btw_request_and_trip_begin", "auto_transformed_derived_fare_split_total_fare_sum_1week", "auto_transformed_derived_minutes_active_sum_2day", "auto_transformed_derived_completed_surge_multiplier_sum_1day", "auto_transformed_derived_completed_surge_count_1day", "auto_transformed_derived_min_driver_speed", "auto_transformed_derived_distance_sum_1day", "auto_transformed_derived_sex_driver_feedback_count_total", "auto_transformed_derived_driver_weekend_trip_count_total", "auto_transformed_derived_driver_cash_count_total", "auto_transformed_derived_fare_split_surge_multiplier_count_1week", "auto_transformed_derived_minutes_worked_sum_5day", "auto_transformed_derived_driver_1star_count_4week", "auto_transformed_derived_minutes_active_sum_8week", "auto_transformed_derived_fare_split_distance_sum_1day", "auto_transformed_derived_completed_distance_sum_1day", "auto_transformed_derived_lifetime_rating_avg", "auto_transformed_derived_driver_1star_count_total", "auto_transformed_derived_fare_split_one_star_count_1week", "auto_transformed_derived_driver_starpower_count_total", "auto_transformed_derived_avg_ata", "auto_transformed_derived_minutes_worked_sum_2week", "auto_transformed_derived_driver_weekend_request_count_total", "auto_transformed_derived_minutes_worked_sum_5week", "auto_transformed_derived_surge_multiplier_count_1day", "auto_transformed_derived_driver_canceled_on_count_total", "auto_transformed_derived_trip_distance_miles_sum_total", "auto_transformed_derived_num_joined_points", "auto_transformed_derived_minutes_worked_sum_1week", "auto_transformed_derived_surge_count_1day", "auto_transformed_derived_eta", "auto_transformed_derived_minutes_worked_sum_6day", "auto_transformed_derived_fare_split_duration_sum_1day", "auto_transformed_derived_trip_count_1day", "auto_transformed_derived_driver_num_ratings_4week", "auto_transformed_derived_driver_1star_count_12week", "auto_transformed_derived_min_distance_btw_rider_and_any_driver_stop", "auto_transformed_derived_driver_upfront_fare_sum_total", "auto_transformed_derived_driver_num_ratings_1week", "auto_transformed_derived_rider_max_dist_to_request", "auto_transformed_derived_fare_split_surge_count_1week", "auto_transformed_derived_rude_driver_feedback_count_total", "auto_transformed_derived_completed_distance_sum_1week", "auto_transformed_derived_driver_black_count_total", "auto_transformed_derived_rider_max_dist_to_pickup", "auto_transformed_derived_driver_avg_daily_rating_12week", "auto_transformed_derived_max_driver_speed", "auto_transformed_derived_driver_avg_daily_rating", "auto_transformed_derived_lifetime_rated_trip_count", "auto_transformed_derived_driver_p2p_count_total", "auto_transformed_derived_request_to_begin_duration_seconds_sum_total", "auto_transformed_derived_fare_split_trip_count_1week", "auto_transformed_derived_minutes_active_sum_4week", "auto_transformed_derived_request_to_begin_distance_miles_sum_total", "auto_transformed_derived_driver_canceled_trip_count_1week", "auto_transformed_derived_driver_avg_daily_rating_4week", "auto_transformed_derived_fare_split_surge_multiplier_sum_1week", "auto_transformed_derived_driver_request_count_total", "auto_transformed_derived_driver_num_ratings_total", "auto_transformed_derived_minutes_worked_sum_8week", "auto_transformed_derived_rider_min_dist_to_request", "auto_transformed_derived_trip_duration_seconds_sum_total", "auto_transformed_derived_driver_avg_daily_rating_1week", "auto_transformed_derived_minutes_worked_sum_1day", "auto_transformed_derived_creepy_driver_feedback_count_total", "auto_transformed_derived_driver_delivery_count_total", "auto_transformed_derived_minutes_active_sum_4day", "auto_transformed_derived_avg_surge_multiplier", "auto_transformed_derived_fare_split_duration_sum_1week", "auto_transformed_derived_minutes_active_sum_6week", "auto_transformed_derived_minutes_worked_sum_3week", "auto_transformed_derived_fare_split_one_star_count_1day", "auto_transformed_derived_surge_count_1week", "auto_transformed_derived_completed_eta_diff_sum_1day", "indexed_response_has_ticket_or_canceled_post_pickup"]

reader_kwargs = dict(schema_fields=schema_fields,
                     hdfs_driver='libhdfs', reader_pool_type='process',
                     workers_count=2,
                     shuffle_row_groups=True,
	             # only read 1/32 of row groups
	             num_epochs=1,
                     shard_count=32,
                     cur_shard=0)
train_epochs = 4

print("tf version:", tf.__version__)
tf.executing_eagerly()

reader = make_batch_reader("hdfs:///user/chongxiaoc/poka_yoke_v2_data",  **reader_kwargs)
dataset = make_petastorm_dataset(reader)
dataset = dataset.unbatch()
dataset = dataset.cache(filename="/tmp/tf_dataset_cache")
#dataset = dataset.shuffle(1000000)
dataset = dataset.batch(8192)
dataset = dataset.prefetch(1)

for epoch in range(train_epochs):
    start = time.perf_counter()
    i = 1
    for t in dataset:
        if (i % 100 == 0):
            end = time.perf_counter()
            print(f"epoch {epoch}: loaded 100 batches in {end-start} seconds.  Avg {(end - start)/100} seconds per batch")
            start = time.perf_counter()
        i += 1

print("done")